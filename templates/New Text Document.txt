<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meal Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Shared styles -->
  <link rel="stylesheet" href="/static/style.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="dark">

<header>
  <h1>Analytics</h1>

  <div class="date-row">
    <input type="date" id="dateInput">
    <span id="dayName"></span>
  </div>

  <div class="header-actions">
    <button id="themeToggle" type="button">ðŸŒ—</button>
    <a href="/" class="link-btn">â¬… Back</a>
  </div>
</header>

<main style="overflow-y:auto; padding:16px 12px 80px;">

  <!-- SUMMARY -->
  <section class="analytics-summary">

    <div class="analytics-card">
      <h2>Today</h2>
      <p class="percent" id="dayPercent">â€“</p>
      <small id="dayBreakdown">â€“</small>
    </div>

    <div class="analytics-card">
      <h2>This Week</h2>
      <p class="percent" id="weekPercent">â€“</p>
      <small id="weekBreakdown">â€“</small>
    </div>

    <div class="analytics-card">
      <h2>This Month</h2>
      <p class="percent" id="monthPercent">â€“</p>
      <small id="monthBreakdown">â€“</small>
    </div>

  </section>

  <!-- CHARTS -->
  <section class="charts">

    <div class="chart-block">
      <h3>Today â€“ Meal Status</h3>
      <canvas id="dayChart"></canvas>
    </div>

    <div class="chart-block">
      <h3>Weekly Completion</h3>
      <canvas id="weekChart"></canvas>
    </div>

    <div class="chart-block">
      <h3>Monthly Distribution</h3>
      <canvas id="monthChart"></canvas>
    </div>

  </section>

</main>

<!-- ==================================================
     THEME TOGGLE (INLINE, SELF-CONTAINED)
     ================================================== -->
<script>
(function () {
  const body = document.body;
  const btn = document.getElementById("themeToggle");

  if (!btn) return;

  const saved = localStorage.getItem("theme") || "dark";
  body.classList.remove("light","dark");
  body.classList.add(saved);

  btn.addEventListener("click", () => {
    const next =
      body.classList.contains("light") ? "dark" : "light";
    body.classList.remove("light","dark");
    body.classList.add(next);
    localStorage.setItem("theme", next);
  });
})();
</script>

<!-- ==================================================
     ANALYTICS LOGIC
     ================================================== -->
<script>
/* ---------- DATE HELPERS (IST) ---------- */
function getISTDate() {
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  return new Date(utc + 5.5 * 60 * 60 * 1000);
}

function formatDate(d) {
  return d.toISOString().split("T")[0];
}

function dayName(d) {
  try {
    return new Date(d + "T00:00:00")
      .toLocaleDateString("en-IN", { weekday: "long" });
  } catch {
    return "";
  }
}

/* ---------- CHART INSTANCES ---------- */
let dayChart = null;
let weekChart = null;
let monthChart = null;

function destroyCharts() {
  [dayChart, weekChart, monthChart].forEach(c => {
    if (c) c.destroy();
  });
}

/* ---------- RENDER CHARTS ---------- */
function renderCharts(data) {
  destroyCharts();

  // DAY (DONUT)
  dayChart = new Chart(
    document.getElementById("dayChart"),
    {
      type: "doughnut",
      data: {
        labels: ["Done", "Partial", "Not done"],
        datasets: [{
          data: [
            data.day.done,
            data.day.partial,
            data.day.not_done
          ],
          backgroundColor: ["#22c55e", "#eab308", "#ef4444"]
        }]
      },
      options: {
        plugins: { legend: { position: "bottom" } }
      }
    }
  );

  // WEEK (LINE)
  weekChart = new Chart(
    document.getElementById("weekChart"),
    {
      type: "line",
      data: {
        labels: data.week.labels.map(d =>
          new Date(d).toLocaleDateString("en-IN", { weekday: "short" })
        ),
        datasets: [{
          label: "Completion %",
          data: data.week.percents,
          borderColor: "#38bdf8",
          backgroundColor: "rgba(56,189,248,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          y: {
            min: 0,
            max: 100,
            ticks: { callback: v => v + "%" }
          }
        }
      }
    }
  );

  // MONTH (BAR)
  monthChart = new Chart(
    document.getElementById("monthChart"),
    {
      type: "bar",
      data: {
        labels: ["Done", "Partial", "Not done"],
        datasets: [{
          data: [
            data.month.done,
            data.month.partial,
            data.month.not_done
          ],
          backgroundColor: ["#22c55e", "#eab308", "#ef4444"]
        }]
      },
      options: {
        plugins: { legend: { display: false } }
      }
    }
  );
}

/* ---------- LOAD ANALYTICS ---------- */
function loadAnalytics(dateStr) {
  fetch(`/analytics/${dateStr}`)
    .then(r => r.json())
    .then(data => {

      document.getElementById("dayPercent").innerText =
        data.day.percent + "%";
      document.getElementById("weekPercent").innerText =
        Math.round(
          data.week.percents.reduce((a,b)=>a+b,0) /
          data.week.percents.length
        ) + "%";
      document.getElementById("monthPercent").innerText =
        data.month.percent + "%";

      document.getElementById("dayBreakdown").innerText =
        `Done ${data.day.done}, Partial ${data.day.partial}, Not done ${data.day.not_done}`;

      document.getElementById("weekBreakdown").innerText =
        "Average of this week";

      document.getElementById("monthBreakdown").innerText =
        `Done ${data.month.done}, Partial ${data.month.partial}, Not done ${data.month.not_done}`;

      renderCharts(data);
    })
    .catch(() => {
      alert("Failed to load analytics");
    });
}

/* ---------- INIT ---------- */
const dateInput = document.getElementById("dateInput");
const dayLabel = document.getElementById("dayName");

const today = formatDate(getISTDate());
dateInput.value = today;
dayLabel.innerText = dayName(today);

loadAnalytics(today);

dateInput.addEventListener("change", () => {
  dayLabel.innerText = dayName(dateInput.value);
  loadAnalytics(dateInput.value);
});
</script>

</body>
</html>